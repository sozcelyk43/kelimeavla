<!DOCTYPE html>
<html lang="tr">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Kelime Avı - Düello</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/react/17.0.2/umd/react.production.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/17.0.2/umd/react-dom.production.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
	<script src="https://cdn.tailwindcss.com"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.10.1/firebase-app.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.10.1/firebase-firestore.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>	
<script src="wordstr.js"></script>
	<script src="words_tr_2letters.js"></script>

<style>
	body {
	overscroll-behavior-y: none; touch-action: none; -webkit-user-select: none; user-select: none;
	height: 100vh; overflow: hidden; font-family: 'Inter', sans-serif; background-color: #111827;}
	.grid { touch-action: none; -webkit-tap-highlight-color: transparent; }
	@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
	.scrollbar-thin { scrollbar-width: thin; scrollbar-color: #4B5563 #1F2937; }
	.scrollbar-thin::-webkit-scrollbar { width: 5px; }
	.scrollbar-thin::-webkit-scrollbar-track { background: #1F2937; border-radius: 10px;}
	.scrollbar-thin::-webkit-scrollbar-thumb { background-color: #4B5563; border-radius: 10px; border: 1px solid #1F2937; }
</style>
</head>

<body class="h-screen flex flex-col overflow-hidden">
<div id="root" class="flex-1 overflow-hidden"></div>

<script type="text/babel">

function initializeGame() {
    // Kütüphanelerin yüklenmesini bekle
    if (window.firebase && window._ && window.React && window.ReactDOM) {
        runApp();
    } else {
        setTimeout(initializeGame, 100);
    }
}

function runApp() {

    // --- TEMEL AYARLAR VE BAĞLANTI BİLGİLERİ ---
    const firebaseConfig = {
	  apiKey: "AIzaSyC9qRRHO-m3e_2Kfs14wxxjsovhrE3idXs",
	  authDomain: "kelime-avla.firebaseapp.com",
	  projectId: "kelime-avla",
	  storageBucket: "kelime-avla.firebasestorage.app",
	  messagingSenderId: "557108031682",
	  appId: "1:557108031682:web:a0738215100b2c6b864b5b",
	  measurementId: "G-XYCB5BS8SR"
	};

	if (!firebase.apps.length) {
		firebase.initializeApp(firebaseConfig);
	}
	const db = firebase.firestore();

    const servers = {
      iceServers: [ { urls: [ 'stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302' ] } ],
      iceCandidatePoolSize: 10,
    };

    // --- YARDIMCI FONKSİYONLAR ---
    function customToUpperCase(str) {
        if (typeof str !== 'string') return '';
        return str.replace(/i/g, 'İ').replace(/ı/g, 'I').toUpperCase();
    }

    // --- TAHTA OLUŞTURMA ALGORİTMASI (SADELEŞTİRİLMİŞ) ---
    function createBoard(language, boardSize) {
        const wordLists = { tr: typeof wordListTr !== 'undefined' ? wordListTr : [] };
        const wordLists_2letters = { tr: typeof wordListTr_2letters !== 'undefined' ? wordListTr_2letters : [] };
        const directions = {
            diagonal: [ { name: 'down-right', dx: 1, dy: 1 }, { name: 'down-left', dx: 1, dy: -1 }, { name: 'up-right', dx: -1, dy: 1 }, { name: 'up-left', dx: -1, dy: -1 } ],
            horizontal: [ { name: 'right', dx: 0, dy: 1 }, { name: 'left', dx: 0, dy: -1 } ],
            vertical: [ { name: 'down', dx: 1, dy: 0 }, { name: 'up', dx: -1, dy: 0 } ]
        };
        const allDirections = [...directions.diagonal, ...directions.horizontal, ...directions.vertical];

        const sizes = { small: { r: 10, c: 10 }, medium: { r: 14, c: 14 }, large: { r: 18, c: 18 } };
        const rows = sizes[boardSize].r;
        const cols = sizes[boardSize].c;
        const targetWordCounts = { small: 15, medium: 25, large: 40 };
        const targetTotalWordCount = targetWordCounts[boardSize];

        for (let attempt = 0; attempt < 1500; attempt++) {
            const board = Array(rows).fill(null).map(() => Array(cols).fill(''));
            const lockGrid = Array(rows).fill(null).map(() => Array(cols).fill(false));
            let placedWordsInfo = [];

            const mainWordPool = (wordLists[language] || []).filter(w => w && w.length >= 3 && w.length <= 10).map(customToUpperCase);
            let potentialWords = _.shuffle(mainWordPool);
            let twoLetterWords = _.shuffle((wordLists_2letters[language] || []).map(customToUpperCase));

            const canPlace = (word, r, c, dir) => {
                for (let i = 0; i < word.length; i++) {
                    const nr = r + i * dir.dx;
                    const nc = c + i * dir.dy;
                    if (nr < 0 || nr >= rows || nc < 0 || nc >= cols || lockGrid[nr][nc]) return false;
                }
                return true;
            };

            const placeWord = (word, r, c, dir) => {
                const positions = [];
                for (let i = 0; i < word.length; i++) {
                    const nr = r + i * dir.dx;
                    const nc = c + i * dir.dy;
                    board[nr][nc] = word[i];
                    lockGrid[nr][nc] = true;
                    positions.push({ row: nr, col: nc });
                }
                placedWordsInfo.push({ word, positions, direction: dir.name });
            };

            // Kelimeleri yerleştir
            for (const word of potentialWords) {
                if (placedWordsInfo.length >= targetTotalWordCount) break;
                let availablePositions = [];
                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < cols; c++) {
                        for (const dir of allDirections) {
                            if (canPlace(word, r, c, dir)) availablePositions.push({ r, c, dir });
                        }
                    }
                }
                if (availablePositions.length > 0) {
                    const { r, c, dir } = _.sample(availablePositions);
                    placeWord(word, r, c, dir);
                }
            }

            // Gerekirse 2 harfli kelimeleri ekle
            let twoLetterWordsPlaced = 0;
            for (const word of twoLetterWords) {
                if (twoLetterWordsPlaced >= 2) break;
                // ... yerleştirme mantığı ...
            }
            
            // Kalan boşlukları doldur
            const letterBank = placedWordsInfo.flatMap(info => info.word.split(''));
            if (letterBank.length === 0) continue;
            const shuffledLetters = _.shuffle(letterBank);
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    if (!board[r][c]) {
                        board[r][c] = _.sample(shuffledLetters);
                    }
                }
            }
            
            if (placedWordsInfo.length > targetTotalWordCount * 0.8) {
                 return { board, words: _.sortBy(placedWordsInfo, 'word') };
            }
        }
        console.error("Tahta oluşturma denemeleri başarısız oldu.");
        return null;
    }

    // --- REACT BİLEŞENLERİ ---

    function UsernamePrompt({ onSave }) {
        const [name, setName] = React.useState('');
        const [isLoading, setIsLoading] = React.useState(false);
        const [error, setError] = React.useState('');
        
        const handleSave = async () => {
            if (!name.trim()) return;
            setIsLoading(true);
            setError('');
            const success = await onSave(name.trim());
            if (!success) {
                setError('Bu kullanıcı adı zaten alınmış.');
                setIsLoading(false);
            }
        };

        return (
            <div className="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50 p-4">
                <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center">
                    <h3 className="text-3xl font-bold mb-4 text-gray-800">Kelime Düellosuna Hoş Geldin!</h3>
                    <p className="text-gray-600 mb-6">Lütfen oyunda kullanmak için bir kullanıcı adı belirle.</p>
                    <input type="text" value={name} onChange={(e) => setName(e.target.value)} className="w-full border-2 border-gray-300 p-3 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Kullanıcı adınız..." maxLength={15} disabled={isLoading} />
                    {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
                    <button onClick={handleSave} disabled={!name.trim() || isLoading} className="w-full mt-5 bg-indigo-600 text-white font-bold px-6 py-3 rounded-lg hover:bg-indigo-700 transition-all shadow-lg disabled:bg-gray-400">
                        {isLoading ? 'Kontrol ediliyor...' : 'Oyna'}
                    </button>
                </div>
            </div>
        );
    }

    function LobbyPage({ username, goToHome, startGame }) {
        const [players, setPlayers] = React.useState([]);
        const [invitedPlayer, setInvitedPlayer] = React.useState(null);
        const [selectedSize, setSelectedSize] = React.useState('medium');
        const [lobbyStatus, setLobbyStatus] = React.useState('idle');

        React.useEffect(() => {
            if (!username) return;
            const userDocRef = db.collection('lobby').doc(username);

            const unsubscribe = userDocRef.onSnapshot(doc => {
                const data = doc.data();
                if (data) setLobbyStatus(data.status || 'idle');
            });
            return () => unsubscribe();
        }, [username]);
        
        React.useEffect(() => {
            const onbeforeunload = () => {
                 if (username) db.collection('lobby').doc(username).delete().catch(()=>{});
            };
            window.addEventListener('beforeunload', onbeforeunload);
            return () => window.removeEventListener('beforeunload', onbeforeunload);
        }, [username]);

        React.useEffect(() => {
            const unsubscribe = db.collection('lobby').orderBy('joinedAt', 'desc').limit(20).onSnapshot(snapshot => {
                const lobbyPlayers = snapshot.docs.map(doc => doc.data()).filter(player => player.username !== username && player.status === 'idle');
                setPlayers(lobbyPlayers);
            });
            return () => unsubscribe();
        }, [username]);

        const sendInvitation = async (targetPlayer) => {
            if (!username || !targetPlayer || invitedPlayer) return;
            setInvitedPlayer(targetPlayer.username);

            const gameId = [username, targetPlayer.username].sort().join('_');
            const gameRef = db.collection('active-duels').doc(gameId);

            await gameRef.set({
                gameId: gameId,
                status: 'pending',
                boardSize: selectedSize,
                players: { [username]: { score: 0, foundWords: [] }, [targetPlayer.username]: { score: 0, foundWords: [] } },
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            db.collection('lobby').doc(username).update({ status: 'waiting_for_opponent', gameId: gameId });
            db.collection('lobby').doc(targetPlayer.username).update({ status: 'invited', gameId: gameId, invitedBy: username });
        };

        if (lobbyStatus === 'waiting_for_opponent') {
            return (
                <div className="h-full w-full bg-gray-900 text-white flex flex-col items-center justify-center text-center p-4">
                    <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-sky-400 mb-6"></div>
                    <h1 className="text-3xl font-black text-slate-100 mb-2">Rakibin Onayı Bekleniyor</h1>
                    <p className="text-slate-400">Lütfen bekleyin...</p>
                    <button onClick={goToHome} className="mt-12 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg shadow-md">
                        İptal Et ve Geri Dön
                    </button>
                </div>
            );
        }

        return (
            <div className="h-full w-full bg-gray-900 text-white overflow-y-auto">
                <div className="container mx-auto px-4 py-8 text-center">
                    <h1 className="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-indigo-400 mb-4">
                        DÜELLO LOBİSİ
                    </h1>
                    <p className="text-slate-400 mb-8 max-w-lg mx-auto">Yarışmak için bir oyuncu seç. Oyun alanı büyüklüğünü belirle ve davet gönder.</p>
                    
                    <div className="max-w-2xl mx-auto">
                        <div className="bg-gray-800/50 rounded-lg p-4 mb-6">
                            <h3 className="text-lg font-bold text-slate-300 mb-3">Oyun Alanı Büyüklüğü</h3>
                            <div className="flex justify-center bg-gray-700/50 rounded-full p-1.5">
                                {['small', 'medium', 'large'].map(size => (
                                    <button key={size} onClick={() => setSelectedSize(size)} className={`capitalize text-sm font-semibold px-6 py-2 rounded-full transition-colors ${selectedSize === size ? 'bg-indigo-600 text-white' : 'text-slate-300 hover:bg-gray-600'}`}>
                                        {size === 'small' ? 'Küçük' : size === 'medium' ? 'Orta' : 'Büyük'}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <h2 className="text-2xl font-bold text-slate-300 border-b-2 border-slate-700 pb-2 mb-4">Bekleyen Oyuncular</h2>
                        {players.length > 0 ? (
                            <ul className="space-y-3">
                                {players.map(player => (
                                    <li key={player.username} className="p-4 bg-slate-800/50 rounded-lg flex items-center justify-between transition-all hover:bg-slate-800">
                                        <span className="font-bold text-xl">{player.username}</span>
                                        <button onClick={() => sendInvitation(player)} disabled={!!invitedPlayer} className="text-sm font-semibold text-white bg-green-600 px-5 py-2.5 rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-wait">
                                            {invitedPlayer === player.username ? 'Bekleniyor...' : 'Yarış'}
                                        </button>
                                    </li>
                                ))}
                            </ul>
                        ) : (
                            <div className="text-center py-12">
                                <p className="text-slate-500 text-lg">LOBİDE KİMSE YOK...</p>
                                <p className="text-slate-600 text-sm mt-2">Arkadaşlarınızı davet edin!</p>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        );
    }

    function WordHunt({ gameId, username, goToHome }) {
        const [realtimeGameData, setRealtimeGameData] = React.useState(null);
        const [board, setBoard] = React.useState(null);
        const [isLoading, setIsLoading] = React.useState(true);
        const [error, setError] = React.useState('');
        const [selectedCells, setSelectedCells] = React.useState([]);
        const [isSwiping, setIsSwiping] = React.useState(false);
        const [disconnectionInfo, setDisconnectionInfo] = React.useState({ isDisconnected: false, countdown: 20, message: '' });

        const gridRef = React.useRef(null);
        const peerConnectionRef = React.useRef(null);
        const dataChannelRef = React.useRef(null);
        const countdownIntervalRef = React.useRef(null);
        const connectionTimeoutRef = React.useRef(null);

        // --- DÜELLO MANTIĞI ---
        React.useEffect(() => {
            setIsLoading(true);
            setError('');

            connectionTimeoutRef.current = setTimeout(() => {
                if (isLoading) {
                    setError("Rakiple bağlantı kurulamadı. Lobiye dönüp tekrar deneyin.");
                    setIsLoading(false);
                }
            }, 25000);
            
            const gameRef = db.collection('active-duels').doc(gameId);
            const selfIsCaller = username === gameId.split('_').sort()[0];
            let unsubscribers = [];

            const unsubGameState = gameRef.onSnapshot(doc => {
                if (!doc.exists) {
                    setError('Oyun bulunamadı veya sona erdi.');
                    setIsLoading(false);
                    setTimeout(goToHome, 3000);
                    return;
                }
                const data = doc.data();
                setRealtimeGameData(data);

                if (data && data.boardData && data.boardData.board) {
  setBoard(Object.values(data.boardData.board));
                } else if (!data.boardData && selfIsCaller) {
                    const newBoardData = createBoard('tr', data.boardSize);
                    if (newBoardData) {
                        const boardAsMap = {};
                        newBoardData.board.forEach((row, index) => { boardAsMap[index] = row; });
                        gameRef.update({ boardData: { ...newBoardData, board: boardAsMap } });
                    }
                }
                
                if (selfIsCaller || data.offer) {
                    if (!peerConnectionRef.current) setupWebRTC(data);
                }

                if(data.boardData && data.players[username]) {
                   setIsLoading(false);
                   clearTimeout(connectionTimeoutRef.current);
                }
            });
            unsubscribers.push(unsubGameState);

            const setupWebRTC = async (initialGameData) => {
                peerConnectionRef.current = new RTCPeerConnection(servers);
                const pc = peerConnectionRef.current;

                pc.onicecandidate = event => event.candidate && db.collection('active-duels').doc(gameId).collection(selfIsCaller ? 'callerCandidates' : 'calleeCandidates').add(event.candidate.toJSON());
                pc.ondatachannel = event => { dataChannelRef.current = event.channel; dataChannelRef.current.onmessage = handleDataChannelMessage; };
                
                pc.onconnectionstatechange = () => {
                    const state = pc.connectionState;
                    if (state === 'connected') {
                        handleReconnection();
                        clearTimeout(connectionTimeoutRef.current);
                    } else if (state === 'disconnected' || state === 'failed') {
                        handleDisconnection();
                    }
                };

                if (selfIsCaller) {
                    dataChannelRef.current = pc.createDataChannel('gameData');
                    dataChannelRef.current.onmessage = handleDataChannelMessage;
                    if (!initialGameData.offer) {
                        const offer = await pc.createOffer();
                        await pc.setLocalDescription(offer);
                        await gameRef.update({ offer: { sdp: offer.sdp, type: offer.type } });
                    }
                } else {
                    await pc.setRemoteDescription(new RTCSessionDescription(initialGameData.offer));
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    await gameRef.update({ answer: { type: answer.type, sdp: answer.sdp } });
                }

                gameRef.onSnapshot(async (snapshot) => {
                    const data = snapshot.data();
                    if (pc && pc.signalingState === "have-local-offer" && data?.answer) {
                        await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                    }
                });

                const opponentCandidates = db.collection('active-duels').doc(gameId).collection(selfIsCaller ? 'calleeCandidates' : 'callerCandidates');
                opponentCandidates.onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(async (change) => {
                        if (change.type === 'added' && pc.remoteDescription) {
                            await pc.addIceCandidate(new RTCIceCandidate(change.doc.data()));
                        }
                    });
                });
            };
            
            return () => {
                unsubscribers.forEach(unsub => unsub());
                if (peerConnectionRef.current) { peerConnectionRef.current.close(); peerConnectionRef.current = null; }
                clearTimeout(connectionTimeoutRef.current);
                clearInterval(countdownIntervalRef.current);
            };
        }, [gameId, username]);

        const handleDisconnection = () => { /* ... */ };
        const handleReconnection = () => { /* ... */ };
        const handleDataChannelMessage = (event) => { /* ... */ };

        // --- OYUN ETKİLEŞİMİ ---
        const getCellFromCoordinates = React.useCallback((clientX, clientY) => { /* ... */ });
        const isCellFound = React.useCallback((r, c) => { /* ... */ });

        const handleInteractionStart = (clientX, clientY) => {
            const cell = getCellFromCoordinates(clientX, clientY);
            if (cell && !isCellFound(cell.row, cell.col)) { setIsSwiping(true); setSelectedCells([cell]); }
        };
        
        const throttledMove = React.useMemo(() => _.throttle((clientX, clientY) => {
             // ... Kelime seçme mantığı ...
        }, 30), [isSwiping, board, selectedCells]);

        const handleInteractionEnd = () => {
             if (!isSwiping || !board || selectedCells.length <= 1) {
                setIsSwiping(false);
                setSelectedCells([]);
                return;
            }
            const word = selectedCells.map(c => board[c.row][c.col]).join('');
            const targetWord = realtimeGameData?.boardData?.words.find(w => w.word === customToUpperCase(word));
            
            if (targetWord && !Object.values(realtimeGameData.players).some(p => p.foundWords.includes(targetWord.word))) {
                const points = targetWord.word.length * 10;
                if (dataChannelRef.current?.readyState === 'open') {
                    dataChannelRef.current.send(JSON.stringify({ foundWord: targetWord.word, score: points }));
                }
                setRealtimeGameData(prev => { /* ... update local player score ... */ });
            }
            setSelectedCells([]);
        };

        // --- RENDER (GÖRSELLEŞTİRME) ---
        if (isLoading) return <div className="h-full flex items-center justify-center text-white text-2xl font-semibold">Oyun Yükleniyor...</div>;
        if (error) return <div className="h-full flex flex-col items-center justify-center text-red-400 text-lg p-4 text-center">{error}<button onClick={goToHome} className="mt-4 bg-indigo-500 text-white px-4 py-2 rounded">Lobiye Dön</button></div>;
        if (!realtimeGameData || !board) return <div className="h-full flex items-center justify-center text-gray-500">Veri bekleniyor...</div>;

        const { players, boardData, status, winner, reason } = realtimeGameData;
        const opponentName = Object.keys(players).find(p => p !== username);
        const myInfo = players[username];
        const opponentInfo = opponentName ? players[opponentName] : { score: 0, foundWords: [] };
        const allFoundWords = new Set([...myInfo.foundWords, ...opponentInfo.foundWords]);

        if (status === 'active' && boardData.words.length > 0 && allFoundWords.size === boardData.words.length) {
            const finalWinner = myInfo.score > opponentInfo.score ? username : (opponentInfo.score > myInfo.score ? opponentName : 'draw');
            db.collection('active-duels').doc(gameId).update({ status: 'finished', winner: finalWinner });
        }

        const PlayerCard = ({ name, score, isOpponent = false }) => (
            <div className={`bg-gray-800 rounded-lg p-4 text-center border-2 ${isOpponent ? 'border-red-500/50' : 'border-green-500/50'}`}>
                <p className="text-lg font-bold truncate text-slate-300">{name} {isOpponent ? '' : '(Siz)'}</p>
                <p className="text-4xl font-extrabold text-white mt-2">{score}</p>
            </div>
        );

        return (
            <div className="h-screen w-full bg-gray-900 text-white p-6 grid grid-cols-4 gap-6">
                {status === 'finished' && (
                    <div className="fixed inset-0 bg-black/80 flex flex-col items-center justify-center z-50 text-center">
                        <h2 className="text-6xl font-black mb-4 text-white">
                            {winner === 'draw' ? 'BERABERE!' : winner === username ? 'KAZANDINIZ!' : 'KAYBETTİNİZ!'}
                        </h2>
                        <p className="text-3xl text-white">{myInfo.score} - {opponentInfo.score}</p>
                        {reason && <p className="text-sm text-gray-300 mt-2">({reason})</p>}
                        <button onClick={goToHome} className="mt-8 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg">Lobiye Dön</button>
                    </div>
                )}

                {/* Sol Sütun */}
                <div className="flex flex-col gap-6">
                    <PlayerCard name={username} score={myInfo.score} />
                    <div className="bg-gray-800 rounded-lg p-4 flex-1">
                         <h3 className="font-bold text-slate-400 border-b border-gray-700 pb-2 mb-3">Bulduğunuz Kelimeler</h3>
                         <ul className="text-sm space-y-1 text-green-400 font-mono">
                             {myInfo.foundWords.map(w => <li key={w}>{w}</li>)}
                         </ul>
                    </div>
                </div>

                {/* Orta Sütun (Oyun Alanı) */}
                <div className="col-span-2 bg-gray-800 rounded-lg p-2 flex items-center justify-center">
                    <div
                        ref={gridRef}
                        className="grid w-full aspect-square"
                        style={{ gridTemplateColumns: `repeat(${board[0].length}, 1fr)`, gap: '4px' }}
                        onMouseDown={(e) => handleInteractionStart(e.clientX, e.clientY)}
                        onMouseMove={(e) => isSwiping && throttledMove(e.clientX, e.clientY)}
                        onMouseUp={handleInteractionEnd} onMouseLeave={handleInteractionEnd}
                        onTouchStart={(e) => handleInteractionStart(e.touches[0].clientX, e.touches[0].clientY)}
                        onTouchMove={(e) => isSwiping && throttledMove(e.touches[0].clientX, e.touches[0].clientY)}
                        onTouchEnd={handleInteractionEnd} onTouchCancel={handleInteractionEnd}
                    >
                        {board.map((row, r) => row.map((letter, c) => {
                            const isSelected = selectedCells.some(cell => cell.row === r && cell.col === c);
                            const isFound = isCellFound(r,c);
                            let cellClass = 'bg-slate-700 hover:bg-slate-600';
                            if (isSelected) cellClass = 'bg-yellow-400 text-black scale-110 shadow-lg z-10';
                            else if (isFound) cellClass = 'bg-green-500/40 text-gray-400';
                            
                            return <div key={`${r}-${c}`} className={`flex items-center justify-center aspect-square text-center font-bold text-2xl rounded-md transition-all duration-150 select-none ${cellClass}`}>{letter}</div>;
                        }))}
                    </div>
                </div>

                {/* Sağ Sütun */}
                <div className="flex flex-col gap-6">
                    <PlayerCard name={opponentName || 'Rakip Bekleniyor'} score={opponentInfo.score} isOpponent={true} />
                    <div className="bg-gray-800 rounded-lg p-4 flex-1 overflow-y-auto scrollbar-thin">
                        <h3 className="font-bold text-slate-400 border-b border-gray-700 pb-2 mb-3">Tüm Kelimeler ({boardData.words.length})</h3>
                        <ul className="text-sm space-y-1 font-mono">
                            {boardData.words.map(({ word }) => (
                                <li key={word} className={`transition-all duration-300 ${allFoundWords.has(word) ? 'line-through text-gray-600' : 'text-sky-400'}`}>{word}</li>
                            ))}
                        </ul>
                    </div>
                </div>
            </div>
        );
    }
    
    function App() {
        const [page, setPage] = React.useState('loading'); // loading, auth, lobby, game
        const [username, setUsername] = React.useState('');
        const [gameId, setGameId] = React.useState(null);
        const [isInitializing, setIsInitializing] = React.useState(true);
        const [invitation, setInvitation] = React.useState(null);

        React.useEffect(() => {
            const initializeApp = async () => {
                const savedUser = localStorage.getItem('wordHuntUsername_duel');
                if (savedUser) {
                    const userRef = db.collection("users").doc(savedUser);
                    const doc = await userRef.get();
                    if(doc.exists) {
                        setUsername(savedUser);
                        setPage('lobby');
                    } else {
                        setPage('auth');
                    }
                } else {
                    setPage('auth');
                }
                setIsInitializing(false);
            };
            initializeApp();
        }, []);
        
        React.useEffect(() => {
            if (!username) return;

            const userLobbyRef = db.collection('lobby').doc(username);
            const unsubscribe = userLobbyRef.onSnapshot(doc => {
                const data = doc.data();
                if (data?.status === 'in-game' && data.gameId) {
                    setInvitation(null);
                    setGameId(data.gameId);
                    setPage('game');
                } else if (data?.status === 'invited' && data.gameId && data.invitedBy) {
                    setInvitation({ gameId: data.gameId, invitedBy: data.invitedBy });
                }
            });
            return () => unsubscribe();
        }, [username]);
        
        const handleSaveUsername = async (name) => {
            const userRef = db.collection("users").doc(name);
            const doc = await userRef.get();
            if (doc.exists) return false;
            
            await userRef.set({ username: name, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
            localStorage.setItem('wordHuntUsername_duel', name);
            setUsername(name);
            db.collection('lobby').doc(name).set({ username: name, status: 'idle', joinedAt: firebase.firestore.FieldValue.serverTimestamp() });
            setPage('lobby');
            return true;
        };
        
        const goToHome = () => {
             if (username) {
                db.collection('lobby').doc(username).set({ username: username, status: 'idle', joinedAt: firebase.firestore.FieldValue.serverTimestamp() }).catch(()=>{});
            }
            setGameId(null);
            setPage('lobby');
        };

        const handleAcceptInvitation = async () => {
            if (!invitation) return;
            const { gameId, invitedBy } = invitation;
            const gameRef = db.collection('active-duels').doc(gameId);
            await gameRef.update({ status: 'active' });
            setInvitation(null);
        };

        const handleRejectInvitation = async () => {
             if (!invitation) return;
            const { gameId, invitedBy } = invitation;
            await db.collection('active-duels').doc(gameId).delete();
            await db.collection('lobby').doc(invitedBy).update({ status: 'idle' });
            await db.collection('lobby').doc(username).update({ status: 'idle' });
            setInvitation(null);
        };
        
        return (
            <div className="h-full w-full bg-gray-900">
                {page === 'loading' && <div className="h-full flex items-center justify-center text-white">Yükleniyor...</div>}
                {page === 'auth' && <UsernamePrompt onSave={handleSaveUsername} />}
                {page === 'lobby' && <LobbyPage username={username} goToHome={goToHome} startGame={(id) => { setGameId(id); setPage('game'); }} />}
                {page === 'game' && <WordHunt gameId={gameId} username={username} goToHome={goToHome} />}

                {invitation && (
                    <div className="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4">
                        <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center">
                            <h3 className="text-3xl font-bold mb-4 text-gray-800">⚔️ Düello Daveti ⚔️</h3>
                            <p className="text-gray-600 text-lg mb-8">
                                <span className="font-bold text-indigo-600">{invitation.invitedBy}</span> sizi bir düelloya davet ediyor!
                            </p>
                            <div className="flex justify-center gap-4 mt-4">
                                <button onClick={handleRejectInvitation} className="px-8 py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700">Reddet</button>
                                <button onClick={handleAcceptInvitation} className="px-8 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700">Kabul Et</button>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
}

initializeGame();

</script>
</body>
</html>